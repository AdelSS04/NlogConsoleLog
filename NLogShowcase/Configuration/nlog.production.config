<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="false"
      internalLogLevel="Warn"
      internalLogFile="logs/internal-nlog-prod.txt">

  <!-- Production Configuration - Optimized for performance and storage -->
  
  <variable name="prodLayout" value="${longdate} [${level:uppercase=true}] ${logger:shortName=true} - ${message} ${exception:format=tostring}" />
  <variable name="jsonProdLayout" value='{"timestamp":"${longdate}","level":"${level:uppercase=true}","logger":"${logger:shortName=true}","message":"${message}","exception":"${exception:format=tostring}","machine":"${machinename}","processid":"${processid}","thread":"${threadid}"}' />

  <targets>
    <!-- Async wrapper for better performance -->
    <target xsi:type="AsyncWrapper" name="asyncFile" queueLimit="10000" overflowAction="Block">
      <target xsi:type="File"
              name="prodFile"
              fileName="logs/app-${shortdate}.log"
              layout="${prodLayout}"
              archiveFileName="logs/archives/app-{#}.log"
              archiveEvery="Day"
              archiveNumbering="Rolling"
              maxArchiveFiles="30"
              archiveOldFileOnStartup="false"
              concurrentWrites="true"
              keepFileOpen="true"
              openFileCacheTimeout="30" />
    </target>

    <!-- Error logs with longer retention -->
    <target xsi:type="AsyncWrapper" name="asyncErrorFile">
      <target xsi:type="File"
              name="prodErrorFile"
              fileName="logs/errors-${shortdate}.log"
              layout="${prodLayout}"
              archiveFileName="logs/archives/errors-{#}.log"
              archiveEvery="Day"
              archiveNumbering="Rolling"
              maxArchiveFiles="90" />
    </target>

    <!-- JSON format for log aggregation systems -->
    <target xsi:type="AsyncWrapper" name="asyncJsonFile">
      <target xsi:type="File"
              name="prodJsonFile"
              fileName="logs/app-${shortdate}.json"
              layout="${jsonProdLayout}"
              archiveFileName="logs/archives/app-{#}.json"
              archiveEvery="Day"
              archiveNumbering="Rolling"
              maxArchiveFiles="30" />
    </target>

    <!-- Console output for containers/systemd -->
    <target xsi:type="Console"
            name="prodConsole"
            layout="${prodLayout}" />
  </targets>

  <rules>
    <!-- Critical errors to error file -->
    <logger name="*" minlevel="Error" writeTo="asyncErrorFile" />
    
    <!-- All important logs to main file -->
    <logger name="*" minlevel="Info" writeTo="asyncFile" />
    
    <!-- Structured JSON logs for analysis -->
    <logger name="*" minlevel="Warn" writeTo="asyncJsonFile" />
    
    <!-- Console for container environments -->
    <logger name="*" minlevel="Info" writeTo="prodConsole" />

    <!-- Suppress Microsoft framework logs in production -->
    <logger name="Microsoft.*" maxlevel="Warn" final="true" />
    <logger name="System.*" maxlevel="Warn" final="true" />
  </rules>
</nlog>